<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeVision AI</title>
    <!-- Tesseract.js for OCR -->
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>
    <!-- Esprima for JavaScript parsing -->
    <script src="https://unpkg.com/esprima@4.0.1/dist/esprima.min.js"></script>
    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-okaidia.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js" defer></script>
    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/acorn/8.10.0/acorn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/acorn-loose/8.4.0/acorn-loose.min.js"></script>
    <style>
        :root {
            --matrix-green: #00ff00;
            --matrix-dark-green: #00cc00;
            --cyberpunk-pink: #ff007f;
            --cyberpunk-blue: #00b7eb;
            --light-bg: #ffffff;
            --light-text: #111827;
            --dark-bg: #0a0a0a;
            --matrix-glow: rgba(0, 255, 0, 0.5);
            --error-red: #ff5555;
            --fix-green: #55ff55;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Courier New', monospace;
            min-height: 100vh;
            transition: all 0.3s;
            position: relative;
            overflow-x: hidden;
            background: var(--dark-bg);
            color: var(--matrix-green);
        }

        /* Theme Styles */
        .matrix-theme {
            background: var(--dark-bg);
            color: var(--matrix-green);
        }

        .cyberpunk-theme {
            background: #1a1a3d;
            color: var(--cyberpunk-pink);
        }

        .light-theme {
            background: var(--light-bg);
            color: var(--light-text);
        }

        /* Matrix Rain Canvas */
        #matrix-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.7;
            filter: blur(1px);
            display: block;
        }

        /* Chat Container */
        .chat-container {
            max-width: 1200px;
            margin: 20px auto;
            border: 2px solid var(--matrix-green);
            border-radius: 10px;
            min-height: 90vh;
            display: flex;
            flex-direction: column;
            background: rgba(0, 10, 0, 0.85);
            box-shadow: 0 0 20px var(--matrix-glow);
        }

        .matrix-theme .chat-container {
            border-color: var(--matrix-green);
            background: rgba(0, 20, 0, 0.8);
        }

        .cyberpunk-theme .chat-container {
            background: rgba(26, 26, 61, 0.85);
            border-color: var(--cyberpunk-pink);
            box-shadow: 0 0 20px rgba(255, 0, 127, 0.3);
        }

        .light-theme .chat-container {
            background: rgba(255, 255, 255, 0.95);
            border-color: #3b82f6;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        /* Messages Area */
        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--matrix-green) transparent;
        }

        .matrix-theme .messages-container::-webkit-scrollbar-thumb {
            background: var(--matrix-green);
            border-radius: 3px;
        }

        .cyberpunk-theme .messages-container::-webkit-scrollbar-thumb {
            background: var(--cyberpunk-pink);
        }

        .light-theme .messages-container::-webkit-scrollbar-thumb {
            background: #3b82f6;
        }

        .message {
            margin: 15px;
            padding: 15px;
            border-radius: 8px;
            max-width: 80%;
            animation: fadeIn 0.5s;
            word-break: break-word;
            white-space: pre-wrap;
        }

        .matrix-theme .message {
            background: rgba(0, 20, 0, 0.8);
            border-color: var(--matrix-green);
        }

        .cyberpunk-theme .message {
            background: rgba(26, 26, 61, 0.8);
            border-color: var(--cyberpunk-pink);
        }

        .light-theme .message {
            background: rgba(241, 245, 249, 0.8);
            border-color: #3b82f6;
        }

        .user-message {
            margin-left: auto;
            border-left: 3px solid var(--matrix-green);
        }

        .bot-message {
            margin-right: auto;
            border-right: 3px solid var(--cyberpunk-blue);
        }

        /* Code Blocks */
        .code-block {
            position: relative;
            margin: 15px 0;
            border-radius: 8px;
            overflow-x: auto;
            font-family: monospace;
            border: 1px solid var(--matrix-green);
            background: rgba(0, 20, 0, 0.9);
        }

        .matrix-theme .code-block {
            border-color: var(--matrix-green);
            background: rgba(0, 20, 0, 0.9);
        }

        .cyberpunk-theme .code-block {
            border-color: var(--cyberpunk-pink);
            background: rgba(26, 26, 61, 0.9);
        }

        .light-theme .code-block {
            border-color: #3b82f6;
            background: rgba(241, 245, 249, 0.9);
        }

        .code-header {
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid var(--matrix-green);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .matrix-theme .code-header {
            border-color: var(--matrix-green);
        }

        .cyberpunk-theme .code-header {
            border-color: var(--cyberpunk-pink);
        }

        .light-theme .code-header {
            border-color: #3b82f6;
        }

        .code-block pre {
            margin: 0;
            padding: 15px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* Diff Styling for Fixes */
        .code-diff {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
        }

        .code-diff .error-line {
            background: var(--error-red);
            color: white;
        }

        .code-diff .fix-line {
            background: var(--fix-green);
            color: black;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            gap: 10px;
            padding: 15px;
            border-top: 1px solid var(--matrix-green);
            flex-wrap: wrap;
        }

        .matrix-theme .toolbar {
            border-color: var(--matrix-green);
        }

        .cyberpunk-theme .toolbar {
            border-color: var(--cyberpunk-pink);
        }

        .light-theme .toolbar {
            border-color: #3b82f6;
        }

        button, select {
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Courier New', monospace;
            border: 1px solid var(--matrix-green);
            background: rgba(0, 255, 0, 0.1);
            color: var(--matrix-green);
        }

        .matrix-theme button, .matrix-theme select {
            border-color: var(--matrix-green);
            background: rgba(0, 255, 0, 0.1);
            color: var(--matrix-green);
        }

        .matrix-theme button:hover, .matrix-theme select:hover {
            background: var(--matrix-green);
            color: var(--dark-bg);
            box-shadow: 0 0 10px var(--matrix-glow);
        }

        .cyberpunk-theme button, .cyberpunk-theme select {
            border-color: var(--cyberpunk-pink);
            background: rgba(255, 0, 127, 0.1);
            color: var(--cyberpunk-pink);
        }

        .cyberpunk-theme button:hover, .cyberpunk-theme select:hover {
            background: var(--cyberpunk-pink);
            color: white;
            box-shadow: 0 0 10px rgba(255, 0, 127, 0.5);
        }

        .light-theme button, .light-theme select {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .light-theme button:hover, .light-theme select:hover {
            background: #3b82f6;
            color: white;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        /* Input Area */
        .input-area {
            display: flex;
            gap: 10px;
            padding: 15px;
            border-top: 1px solid var(--matrix-green);
            position: relative;
        }

        .matrix-theme .input-area {
            border-color: var(--matrix-green);
        }

        .cyberpunk-theme .input-area {
            border-color: var(--cyberpunk-pink);
        }

        .light-theme .input-area {
            border-color: #3b82f6;
        }

        textarea {
            flex: 1;
            padding: 12px;
            border-radius: 5px;
            resize: vertical;
            font-family: 'Courier New', monospace;
            background: rgba(0, 20, 0, 0.9);
            border: 1px solid var(--matrix-green);
            color: var(--matrix-green);
        }

        .cyberpunk-theme textarea {
            background: rgba(26, 26, 61, 0.9);
            border-color: var(--cyberpunk-pink);
            color: var(--cyberpunk-blue);
        }

        .light-theme textarea {
            background: rgba(241, 245, 249, 0.9);
            border-color: #3b82f6;
            color: var(--light-text);
        }

        /* Suggestions Dropdown */
        .suggestions-dropdown {
            position: absolute;
            bottom: 100%;
            left: 15px;
            right: 15px;
            max-width: 100%;
            background: rgba(0, 10, 0, 0.9);
            border: 1px solid var(--matrix-green);
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            box-shadow: 0 4px 10px var(--matrix-glow);
            box-sizing: border-box;
        }

        .matrix-theme .suggestions-dropdown {
            background: rgba(0, 20, 0, 0.9);
            border-color: var(--matrix-green);
        }

        .cyberpunk-theme .suggestions-dropdown {
            background: rgba(26, 26, 61, 0.9);
            border-color: var(--cyberpunk-pink);
        }

        .light-theme .suggestions-dropdown {
            background: rgba(241, 245, 249, 0.9);
            border-color: #3b82f6;
        }

        .suggestion-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--matrix-green);
        }

        .matrix-theme .suggestion-item {
            border-color: var(--matrix-green);
        }

        .cyberpunk-theme .suggestion-item {
            border-color: var(--cyberpunk-pink);
        }

        .light-theme .suggestion-item {
            border-color: #3b82f6;
        }

        .suggestion-item:hover {
            background: var(--matrix-green);
            color: var(--dark-bg);
        }

        .cyberpunk-theme .suggestion-item:hover {
            background: var(--cyberpunk-pink);
            color: white;
        }

        .light-theme .suggestion-item:hover {
            background: #3b82f6;
            color: white;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: -300px;
            top: 0;
            width: 300px;
            height: 100%;
            background: rgba(0, 10, 0, 0.95);
            border-right: 2px solid var(--matrix-green);
            transition: left 0.3s;
            padding: 20px;
            z-index: 1000;
        }

        .sidebar.open {
            left: 0;
        }

        .cyberpunk-theme .sidebar {
            background: rgba(26, 26, 61, 0.95);
            border-color: var(--cyberpunk-pink);
        }

        .light-theme .sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-color: #3b82f6;
        }

        .snippet-item {
            padding: 10px;
            border: 1px solid var(--matrix-green);
            margin-bottom: 10px;
            cursor: pointer;
            border-radius: 5px;
        }

        .cyberpunk-theme .snippet-item {
            border-color: var(--cyberpunk-pink);
        }

        .light-theme .snippet-item {
            border-color: #3b82f6;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .chat-container {
                margin: 10px;
                min-height: 95vh;
            }

            .toolbar {
                flex-direction: column;
            }

            .input-area {
                flex-direction: column;
            }

            .sidebar {
                width: 250px;
            }
        }

        @media (max-width: 480px) {
            .chat-container {
                margin: 5px;
                min-height: 98vh;
            }

            .input-area textarea {
                font-size: 14px;
            }

            .toolbar button, .toolbar select {
                font-size: 12px;
                padding: 6px 10px;
            }
        }
    </style>
</head>
<body class="matrix-theme">
    <canvas id="matrix-canvas"></canvas>
    <div class="chat-container">
        <div id="chat-messages" class="messages-container"></div>
        <div class="toolbar">
            <select id="theme-selector">
                <option value="matrix">Matrix</option>
                <option value="cyberpunk">Cyberpunk</option>
                <option value="light">Light</option>
            </select>
            <select id="language-selector">
                <option value="js">JavaScript</option>
                <option value="py">Python</option>
                <option value="java">Java</option>
                <option value="cpp">C++</option>
                <option value="html">HTML</option>
                <option value="css">CSS</option>
                <option value="php">PHP</option>
                <option value="ruby">Ruby</option>
                <option value="go">Go</option>
                <option value="ts">TypeScript</option>
                <option value="sql">SQL</option>
                <option value="rust">Rust</option>
                <option value="kotlin">Kotlin</option>
                <option value="swift">Swift</option>
                <option value="other">Other</option>
            </select>
            <input type="file" id="file-upload" hidden accept=".js,.py,.java,.cpp,.html,.css,.php,.rb,.go,.ts,.sql,.rs,.kt,.swift,.txt,image/*">
            <button onclick="document.getElementById('file-upload').click()">
                <i class="fas fa-upload"></i> Upload File/Image
            </button>
            <button onclick="analyzeCode()"><i class="fas fa-search"></i> Analyze</button>
            <button onclick="debugCode()"><i class="fas fa-bug"></i> Debug</button>
            <button onclick="completeCode()"><i class="fas fa-code"></i> Complete</button>
            <button onclick="teachMode()"><i class="fas fa-chalkboard-teacher"></i> Teach</button>
            <button onclick="formatCode()"><i class="fas fa-broom"></i> Format</button>
            <button onclick="saveSnippet()"><i class="fas fa-save"></i> Save Snippet</button>
            <button onclick="clearChat()"><i class="fas fa-trash"></i> Clear Chat</button>
            <button onclick="toggleSidebar()"><i class="fas fa-code"></i> Snippets</button>
            <button onclick="vfs.createFile('test.txt', document.getElementById('user-input').value)">
                <i class="fas fa-file"></i> Save to VFS
            </button>
            <button onclick="vfs.listFiles()">
                <i class="fas fa-folder"></i> List Files
            </button>
            <button onclick="collab.createSession(document.getElementById('user-input').value)">
                <i class="fas fa-share"></i> Create Session
            </button>
            <input id="session-id" placeholder="Enter session ID">
            <button onclick="collab.joinSession(document.getElementById('session-id').value)">
                <i class="fas fa-users"></i> Join Session
            </button>
        </div>
        <div class="input-area">
            <textarea id="user-input" placeholder="Yo, paste some code or ask me to debug, complete, or teach!"></textarea>
            <div id="suggestions-dropdown" class="suggestions-dropdown hidden"></div>
            <button onclick="processInput()"><i class="fas fa-paper-plane"></i> Send</button>
        </div>
    </div>
    <div class="sidebar" id="sidebar">
        <h3>Snippets</h3>
        <div id="snippet-list"></div>
    </div>

    <script>
        // Knowledge Base
        const KnowledgeBase = {
            greetings: ['hello', 'hi', 'hey', 'yo'],
            codeGen: {
                js: {
                    'function': `function name(params) {\n    // Your code here\n    return result;\n}`,
                    'loop': `for (let i = 0; i < length; i++) {\n    // Do stuff\n}`,
                    'async': `async function name() {\n    const data = await fetch(url);\n    return data.json();\n}`,
                    'class': `class Name {\n    constructor() {\n        this.prop = value;\n    }\n    method() {\n        return result;\n    }\n}`
                },
                py: {
                    'function': `def name(params):\n    # Your code here\n    return result`,
                    'loop': `for i in range(length):\n    # Do stuff`,
                    'class': `class Name:\n    def __init__(self):\n        self.prop = value\n    def method(self):\n        return result`
                },
                java: {
                    'method': `public Type name(Type params) {\n    // Your code here\n    return result;\n}`,
                    'loop': `for (int i = 0; i < length; i++) {\n    // Do stuff\n}`,
                    'class': `public class Name {\n    private Type prop;\n    public Name(Type prop) {\n        this.prop = prop;\n    }\n    public Type method() {\n        return result;\n    }\n}`
                },
                cpp: {
                    'function': `Type name(Type params) {\n    // Your code here\n    return result;\n}`,
                    'loop': `for (int i = 0; i < length; i++) {\n    // Do stuff\n}`,
                    'class': `class Name {\nprivate:\n    Type prop;\npublic:\n    Name(Type prop) : prop(prop) {}\n    Type method() {\n        return result;\n    }\n};`
                },
                html: {
                    'page': `<!DOCTYPE html>\n<html>\n<head>\n    <title>Title</title>\n</head>\n<body>\n    Content\n</body>\n</html>`,
                    'div': `<div class="container">\n    Content\n</div>`
                },
                css: {
                    'style': `.class {\n    property: value;\n}`,
                    'flex': `.container {\n    display: flex;\n    justify-content: center;\n}`
                },
                php: {
                    'function': `function name($params) {\n    // Your code here\n    return $result;\n}`,
                    'loop': `for ($i = 0; $i < $length; $i++) {\n    // Do stuff\n}`
                },
                ruby: {
                    'method': `def name(params)\n    # Your code here\n    result\nend`,
                    'loop': `length.times do |i|\n    # Do stuff\nend`
                },
                go: {
                    'function': `func name(params Type) Type {\n    // Your code here\n    return result\n}`,
                    'loop': `for i := 0; i < length; i++ {\n    // Do stuff\n}`
                },
                ts: {
                    'function': `function name(params: Type): Type {\n    // Your code here\n    return result;\n}`,
                    'interface': `interface Name {\n    prop: Type;\n}`
                },
                sql: {
                    'query': `SELECT column FROM table WHERE condition;\n`,
                    'join': `SELECT a.column, b.column\nFROM table_a a\nJOIN table_b b ON a.id = b.id;`
                },
                rust: {
                    'function': `fn name(param: Type) -> ReturnType {\n    // Code\n}`,
                    'struct': `struct Name {\n    field: Type,\n}`,
                    'loop': `for i in 0..10 {\n    println!("{}", i);\n}`
                },
                kotlin: {
                    'function': `fun name(param: Type): ReturnType {\n    // Code\n}`,
                    'class': `class Name(val property: Type) {\n    fun method() {\n        // Code\n    }\n}`
                },
                swift: {
                    'function': `func name(param: Type) -> ReturnType {\n    // Code\n}`,
                    'class': `class Name: Superclass {\n    var property: Type\n    \n    init(property: Type) {\n        self.property = property\n    }\n}`
                }
            },
            errors: {
                js: {
                    'ReferenceError': 'Used a variable that’s not defined. Check if it’s declared or in scope.',
                    'SyntaxError': 'Syntax is off—missing a bracket, semicolon, or something?',
                    'TypeError': 'Wrong data type for that operation. Check your types.',
                    'AsyncIssue': 'Async function might need `await` or proper promise handling.'
                },
                py: {
                    'NameError': 'Variable doesn’t exist. Check spelling or declare it.',
                    'SyntaxError': 'Syntax glitch—missing colons or wrong indentation?',
                    'IndentationError': 'Indentation’s messy. Use 4 spaces consistently.'
                },
                java: {
                    'NullPointerException': 'Accessing a null object. Check initialization.',
                    'SyntaxError': 'Code won’t compile—missing semicolons or braces?'
                },
                cpp: {
                    'Segmentation Fault': 'Bad memory access. Check pointers or array bounds.',
                    'SyntaxError': 'Code’s broken—missing semicolon or brace?'
                },
                html: {
                    'Missing Tag': 'HTML’s incomplete. Close all your tags.',
                    'Invalid Attribute': 'That attribute’s not valid. Check HTML spec.'
                },
                css: {
                    'Invalid Property': 'CSS property’s wrong. Check spelling or support.'
                },
                php: {
                    'Undefined Variable': 'Used an undefined variable. Check your $vars.',
                    'SyntaxError': 'Missing semicolon or closing tag?'
                },
                ruby: {
                    'NameError': 'Variable or method not defined. Check spelling or scope.',
                    'SyntaxError': 'Missing `end` or bad syntax?'
                },
                go: {
                    'Panic': 'Code crashed. Check nil pointers or error handling.',
                    'SyntaxError': 'Missing brace or semicolon?'
                },
                ts: {
                    'TypeError': 'Type mismatch. Check TypeScript types/interfaces.',
                    'SyntaxError': 'Missing type annotation or bad syntax?'
                },
                sql: {
                    'SyntaxError': 'Query’s off. Missing commas or wrong keywords?',
                    'Table Not Found': 'Table doesn’t exist. Verify name or database.'
                },
                rust: {
                    'BorrowError': 'Violated Rust ownership rules. Check borrow checker.',
                    'LifetimeError': 'Incorrect lifetime annotations. Verify references.',
                    'TypeMismatch': 'Strict type mismatch. Check variable types.'
                },
                kotlin: {
                    'NullPointer': 'Potential NPE. Use safe calls (?.) or null checks.',
                    'TypeMismatch': 'Type mismatch. Check generic types and casts.'
                },
                swift: {
                    'NilError': 'Unexpected nil value. Check optional unwrapping.',
                    'TypeMismatch': 'Type mismatch. Verify type annotations.'
                }
            },
            fixes: {
                js: {
                    'ReferenceError': 'Declare the variable or check scope.\n**Before:**\n```js\nconsole.log(x);\n```\n**After:**\n```js\nlet x = 0;\nconsole.log(x);\n```',
                    'AsyncIssue': 'Add `await` or handle promises.\n**Before:**\n```js\nasync function test() { fetch(url); }\n```\n**After:**\n```js\nasync function test() { const res = await fetch(url); return res.json(); }\n```'
                },
                py: {
                    'IndentationError': 'Fix indentation to 4 spaces.\n**Before:**\n```py\ndef test():\n  print("Hi")\n```\n**After:**\n```py\ndef test():\n    print("Hi")\n```'
                },
                java: {
                    'NullPointerException': 'Initialize the object.\n**Before:**\n```java\nString s; s.length();\n```\n**After:**\n```java\nString s = ""; s.length();\n```'
                },
                cpp: {
                    'Segmentation Fault': 'Check pointer validity.\n**Before:**\n```cpp\nint* p; *p = 5;\n```\n**After:**\n```cpp\nint* p = new int; *p = 5;\n```'
                },
                sql: {
                    'SyntaxError': 'Fix query syntax.\n**Before:**\n```sql\nSELECT * FROM users WHERE id = 1\n```\n**After:**\n```sql\nSELECT * FROM users WHERE id = 1;\n```'
                }
            },
            optimizations: {
                js: ['Use `const` for immutable vars.', 'Avoid globals—keep it scoped.', 'Use arrow functions for concise code.'],
                py: ['List comprehensions over loops.', 'Use f-strings for strings.', 'Extract duplicate code to functions.'],
                java: ['StringBuilder for string concat.', 'Use generics for type safety.', 'Try-with-resources for resources.'],
                cpp: ['Pass by reference for big objects.', 'Use const for safety.', 'Smart pointers over raw pointers.'],
                html: ['Minify HTML for speed.', 'Use semantic tags for accessibility.'],
                css: ['Combine selectors to slim CSS.', 'Use CSS variables for reuse.', 'Avoid !important.'],
                php: ['Prepared statements for SQL safety.', 'Cache queries.', 'Avoid globals.'],
                ruby: ['Symbols for keys.', 'Use blocks for brevity.', 'Keep code flat.'],
                go: ['Goroutines for concurrency.', 'Explicit error handling.', 'Small, focused functions.'],
                ts: ['Interfaces for types.', 'Strict mode for safety.', 'Avoid `any`.'],
                sql: ['Index queried columns.', 'Optimize JOINs.', 'Normalize database.'],
                rust: ['Use &str instead of String for slices', 'Prefer iterators over index-based loops', 'Use #[derive(Debug)] for structs'],
                kotlin: ['Use scope functions (let/apply/run)', 'Prefer sealed classes for state management', 'Use coroutines for async operations'],
                swift: ['Use optionals for safety', 'Leverage closures for concise code', 'Use SwiftUI for modern UI']
            },
            tutorials: {
                js: {
                    'function': {
                        steps: [
                            'Functions are reusable code blocks. Define ‘em once, call ‘em anytime.',
                            'Check this:\n```js\nfunction greet(name) {\n    return `Yo ${name}!`;\n}\nconsole.log(greet("Coder"));\n```',
                            'Try writing a function that does something cool.'
                        ],
                        exercise: 'Make a function `multiply(a, b)` that returns `a * b`. Test it with `multiply(3, 4)`.'
                    },
                    'closure': {
                        steps: [
                            'Closures let a function keep outer variables after the outer function’s gone.',
                            'Here’s one:\n```js\nfunction outer() {\n    let count = 0;\n    return () => count++;\n}\nconst counter = outer();\nconsole.log(counter()); // 0\nconsole.log(counter()); // 1\n```',
                            'Great for private state or counters.'
                        ],
                        exercise: 'Create a closure that tracks function calls.'
                    }
                },
                py: {
                    'function': {
                        steps: [
                            'Functions in Python are for reusable code. Use `def` to make ‘em.',
                            'Like this:\n```py\ndef greet(name):\n    return f"Yo {name}!"\nprint(greet("Coder"))\n```',
                            'Try a function that does math.'
                        ],
                        exercise: 'Write `square(num)` to return `num * num`. Test with `square(5)`.'
                    }
                },
                java: {
                    'class': {
                        steps: [
                            'Classes are blueprints for objects, bundling data and methods.',
                            'Here’s one:\n```java\npublic class Person {\n    String name;\n    public Person(String name) {\n        this.name = name;\n    }\n    public String greet() {\n        return "Yo, I’m " + name;\n    }\n}\n```',
                            'Try a class with a method.'
                        ],
                        exercise: 'Make a `Calculator` class with `add(a, b)` to return `a + b`.'
                    }
                },
                rust: {
                    'ownership': {
                        steps: [
                            'Rust ownership rules: 1. Each value has owner\n2. One owner at a time\n3. Owner out of scope → value dropped',
                            'Example:\n```rust\nlet s1 = String::from("hello");\nlet s2 = s1; // s1 invalidated\n```',
                            'Use borrowing (&) for temporary access\n```rust\nfn print_len(s: &String) {\n    println!("{}", s.len());\n}```'
                        ],
                        exercise: 'Create function transferring ownership of a Vec<i32>'
                    }
                }
            },
            security: {
                web: ['Sanitize inputs to prevent XSS', 'Use CSP headers for content security', 'Validate file uploads thoroughly'],
                crypto: ['Never roll your own crypto', 'Use Argon2 for password hashing', 'Rotate secrets regularly'],
                general: ['Principle of least privilege', 'Defense in depth strategy', 'Regular dependency updates']
            },
            performance: {
                frontend: ['Critical CSS in <head>', 'Lazy load non-critical resources', 'Use IntersectionObserver for scroll events'],
                backend: ['Cache database queries', 'Use connection pooling', 'Implement rate limiting'],
                algorithms: ['Choose proper Big-O complexity', 'Memoize expensive computations', 'Use spatial partitioning']
            }
        };

        // Matrix Rain Effect
        const canvas = document.getElementById('matrix-canvas');
        const ctx = canvas.getContext('2d');
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%^&*()';
        const fontSize = 14;
        const columns = Math.floor(window.innerWidth / fontSize);
        const drops = Array(columns).fill(1);
        let lastFrame = 0;

        function drawMatrix(timestamp) {
            if (timestamp - lastFrame < 16) {
                requestAnimationFrame(drawMatrix);
                return;
            }
            lastFrame = timestamp;
            ctx.fillStyle = 'rgba(10, 10, 10, 0.05)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            drops.forEach((y, x) => {
                const text = chars[Math.floor(Math.random() * chars.length)];
                ctx.fillStyle = Math.random() > 0.9 ? '#00cc00' : '#00ff00';
                ctx.font = `${fontSize}px 'Courier New', monospace`;
                ctx.fillText(text, x * fontSize, y * fontSize);
                if (y * fontSize > canvas.height && Math.random() > 0.975) drops[x] = 0;
                drops[x]++;
            });
            requestAnimationFrame(drawMatrix);
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        function updateMatrixCanvas() {
            canvas.style.display = document.body.classList.contains('matrix-theme') ? 'block' : 'none';
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        drawMatrix();
        updateMatrixCanvas();

        // Code Completer
        class CodeCompleter {
            complete(code, lang) {
                const completions = [];
                const lines = code.split('\n').map(line => line.trim());
                const lastLine = lines[lines.length - 1];

                const context = {
                    functionName: lastLine.match(/function\s+(\w+)/)?.[1] || lastLine.match(/def\s+(\w+)/)?.[1] || lastLine.match(/fn\s+(\w+)/)?.[1],
                    className: lines.join(' ').match(/class\s+(\w+)/)?.[1],
                    variables: lines.join(' ').match(/(let|const|var|self\.)\s+(\w+)/g)?.map(v => v.split(' ')[1]) || []
                };

                if (lang in KnowledgeBase.codeGen) {
                    for (const type in KnowledgeBase.codeGen[lang]) {
                        if (lastLine.includes(type)) {
                            completions.push({
                                code: KnowledgeBase.codeGen[lang][type].replace('name', context.functionName || `my_${type}`),
                                description: `Suggested ${type} for ${lang.toUpperCase()}`
                            });
                        }
                    }
                }

                if (completions.length === 0) {
                    for (const type in KnowledgeBase.codeGen[lang] || {}) {
                        completions.push({
                            code: KnowledgeBase.codeGen[lang][type],
                            description: `Generic ${type} for ${lang.toUpperCase()}`
                        });
                    }
                }

                return completions;
            }
        }

        // Security Scanner
        class SecurityScanner {
            scan(code, lang) {
                const issues = [];
                if (/(eval\(|new Function)/.test(code)) {
                    issues.push({
                        category: 'web',
                        severity: 'HIGH',
                        message: 'Detected dangerous eval usage'
                    });
                }
                if (lang === 'sql' && !/WHERE\s+\w+\s*=\s*/.test(code)) {
                    issues.push({
                        category: 'database',
                        severity: 'CRITICAL',
                        message: 'Potential SQL injection - use parameterized queries'
                    });
                }
                return issues;
            }
        }

        // Performance Analyzer
        class PerformanceAnalyzer {
            analyze(code, lang) {
                return {
                    metrics: {
                        complexity: this.calculateCyclomaticComplexity(code),
                        linesOfCode: code.split('\n').length,
                        memoryUsage: this.estimateMemoryUsage(code, lang)
                    },
                    optimizations: KnowledgeBase.performance[lang] || []
                };
            }

            calculateCyclomaticComplexity(code) {
                const controlStructures = (code.match(/if|for|while|switch|catch/g) || []).length;
                return controlStructures + 1;
            }

            estimateMemoryUsage(code, lang) {
                const variables = (code.match(/(let|const|var|def|val)\s+\w+/g) || []).length;
                return variables * 8;
            }
        }

        // Code Reviewer
        class CodeReviewer {
            review(code, lang) {
                const comments = [];
                if (code.length > 500) {
                    comments.push('Consider splitting into smaller functions');
                }
                if (lang === 'js' && !code.includes('use strict')) {
                    comments.push('Add "use strict" directive');
                }
                return comments;
            }
        }

        // Virtual File System
        class VirtualFileSystem {
            constructor() {
                this.files = new Map();
                this.currentDir = '/';
            }

            createFile(path, content) {
                this.files.set(this.currentDir + path, content);
                addMessage(`Created file: ${path}`, false);
            }

            readFile(path) {
                const content = this.files.get(this.currentDir + path);
                if (content) {
                    addMessage(`File ${path}:\n\`\`\`\n${content}\n\`\`\``, false);
                    return content;
                }
                addMessage(`File ${path} not found`, false);
                return null;
            }

            listFiles() {
                const files = Array.from(this.files.keys()).filter(p => p.startsWith(this.currentDir));
                addMessage(`Files in ${this.currentDir}:\n${files.join('\n')}`, false);
            }
        }

        // Collaboration System
        class CollaborationSystem {
            constructor() {
                this.sessions = new Map();
            }

            createSession(code) {
                const sessionId = Math.random().toString(36).slice(2);
                this.sessions.set(sessionId, code);
                addMessage(`Session created! Share this ID: ${sessionId}`, false);
                return sessionId;
            }

            joinSession(sessionId) {
                const code = this.sessions.get(sessionId);
                if (code) {
                    document.getElementById('user-input').value = code;
                    addMessage(`Joined session ${sessionId}`, false);
                } else {
                    addMessage(`Session ${sessionId} not found`, false);
                }
            }
        }

        // Conversational AI
        class CodeVisionAI {
            constructor() {
                this.completer = new CodeCompleter();
                this.securityScanner = new SecurityScanner();
                this.performanceAnalyzer = new PerformanceAnalyzer();
                this.codeReviewer = new CodeReviewer();
            }

            processQuery(query, lang, codeOnly = false) {
                query = query.toLowerCase().trim();

                if (codeOnly) {
                    const completions = this.completer.complete(query, lang);
                    return completions.length > 0
                        ? completions.map(c => `**Suggestion:** ${c.description}\n\`\`\`${lang}\n${c.code}\n\`\`\``).join('\n')
                        : `No completions found for this ${lang.toUpperCase()} code. Try something like "function myFunc(" or ask for help!`;
                }

                if (KnowledgeBase.greetings.some(g => query.includes(g))) {
                    return `Yo, what’s up? Ready to crush some ${lang.toUpperCase()} code?`;
                }

                if (query.includes('write') || query.includes('create') || query.includes('generate')) {
                    for (const type in KnowledgeBase.codeGen[lang]) {
                        if (query.includes(type)) {
                            return `Here’s a slick ${type} in ${lang.toUpperCase()}:\n\`\`\`${lang}\n${KnowledgeBase.codeGen[lang][type]}\n\`\`\`\nNeed to tweak it?`;
                        }
                    }
                    return `What kinda ${lang.toUpperCase()} code you want? Like a function, class, or loop?`;
                }

                if (query.includes('explain') || query.includes('what is') || query.includes('how does')) {
                    for (const topic in KnowledgeBase.tutorials[lang] || {}) {
                        if (query.includes(topic)) {
                            const tutorial = KnowledgeBase.tutorials[lang][topic];
                            return `Lemme break down ${topic} in ${lang.toUpperCase()}:\n${tutorial.steps.join('\n\n')}\n\n**Try this:** ${tutorial.exercise}`;
                        }
                    }
                    return `What’s puzzling you in ${lang.toUpperCase()}? Share code or ask about stuff like "closures".`;
                }

                if (query.includes('teach') || query.includes('learn')) {
                    for (const topic in KnowledgeBase.tutorials[lang] || {}) {
                        if (query.includes(topic)) {
                            const tutorial = KnowledgeBase.tutorials[lang][topic];
                            return `Let’s dive into ${topic} in ${lang.toUpperCase()}!\n${tutorial.steps.join('\n\n')}\n\n**Your turn:** ${tutorial.exercise}`;
                        }
                    }
                    return `Wanna learn ${lang.toUpperCase()}? Say something like "teach me functions".`;
                }

                if (query.includes('debug') || query.includes('fix') || query.includes('error')) {
                    return `Got buggy ${lang.toUpperCase()} code? Paste it, and I’ll help squash those bugs!`;
                }

                if (query.includes('complete') || query.includes('suggest')) {
                    return `Drop some ${lang.toUpperCase()} code, and I’ll suggest completions like GitHub Copilot!`;
                }

                if (query.includes('how to') || query.includes('best way')) {
                    return `I got you in ${lang.toUpperCase()}! For example: ${KnowledgeBase.optimizations[lang][0]}\nWhat’s the plan?`;
                }

                return `I’m here to code like a boss in ${lang.toUpperCase()}! Ask me to write, debug, complete, or teach. What’s good?`;
            }

            analyzeCode(code, lang) {
                let results = { errors: [], warnings: [], suggestions: [] };

                if (lang === 'js') {
                    try {
                        esprima.parseScript(code);
                    } catch (e) {
                        results.errors.push(`SyntaxError: ${e.description} at line ${e.lineNumber}`);
                    }
                    if (!code.includes(';')) results.warnings.push('Missing semicolons—could mess things up.');
                    if (code.includes('var')) results.suggestions.push('Use `let` or `const` instead of `var`.');
                } else if (lang === 'py') {
                    if (!/^\s{4}/.test(code)) results.warnings.push('Inconsistent indentation—use 4 spaces.');
                    if (code.includes('print ')) results.suggestions.push('Use `print()` for Python 3.');
                } else if (lang === 'rust') {
                    if (code.includes('let') && !code.includes(':')) results.warnings.push('Missing type annotations.');
                }

                results.suggestions.push(...KnowledgeBase.optimizations[lang] || []);
                return results;
            }

            debugCode(code, lang) {
                const issues = [];
                const fixes = [];

                for (const error in KnowledgeBase.errors[lang]) {
                    if (code.match(new RegExp(error, 'i'))) {
                        issues.push(`${error}: ${KnowledgeBase.errors[lang][error]}`);
                        if (KnowledgeBase.fixes[lang] && KnowledgeBase.fixes[lang][error]) {
                            fixes.push(KnowledgeBase.fixes[lang][error]);
                        }
                    }
                }

                if (lang === 'js') {
                    if (code.includes('async') && !code.includes('await')) {
                        issues.push('AsyncIssue: Async function missing `await`.');
                        fixes.push(KnowledgeBase.fixes.js.AsyncIssue);
                    }
                } else if (lang === 'sql') {
                    if (code.includes('DELETE') && !code.includes('WHERE')) {
                        issues.push('Safety: DELETE without WHERE—risks wiping entire table.');
                    }
                }

                return { issues, fixes };
            }

            analyzeSecurity(code, lang) {
                const issues = this.securityScanner.scan(code, lang);
                return {
                    securityIssues: issues,
                    recommendations: issues.map(issue => ({
                        message: issue.message,
                        fix: KnowledgeBase.security[issue.category]?.join('\n- ') || 'Follow general security practices.'
                    }))
                };
            }

            analyzePerformance(code, lang) {
                return this.performanceAnalyzer.analyze(code, lang);
            }

            codeReview(code, lang) {
                return this.codeReviewer.review(code, lang);
            }

            suggestPatterns(code, lang) {
                const patterns = {
                    js: ['Microservices', 'Serverless', 'Event Sourcing'],
                    py: ['MVVM', 'Dependency Injection', 'CQRS'],
                    rust: ['Actor Model', 'Zero-Cost Abstractions', 'RAII']
                };
                return patterns[lang] || ['Modular Architecture', 'Layered Architecture'];
            }

            refactorCode(code, lang, strategy) {
                return code; // Stub
            }

            generateDocs(code, lang) {
                return `/** Generated docs for ${lang} */\n`; // Stub
            }

            translateCode(code, fromLang, toLang) {
                return code; // Stub
            }

            detectVulnerabilities(code, lang) {
                return []; // Stub
            }

            enforceStyle(code, lang, config) {
                return code; // Stub
            }

            generateTests(code, lang, framework) {
                return ''; // Stub
            }
        }

        // Initialize Systems
        const ai = new CodeVisionAI();
        const vfs = new VirtualFileSystem();
        const collab = new CollaborationSystem();

        // OCR Processor
        async function processImage(file) {
            if (file.size > 5 * 1024 * 1024) {
                addMessage('Image too large! Max 5MB.', false);
                return null;
            }
            try {
                addMessage('Scanning image...', false);
                const { data: { text } } = await Tesseract.recognize(file, 'eng', {
                    logger: m => console.log(m)
                });
                const cleanedText = text.replace(/\s+/g, ' ').trim();
                const lang = detectLanguage(cleanedText);
                addMessage(`Extracted code:\n\`\`\`${lang}\n${cleanedText}\n\`\`\``, true, lang);
                document.getElementById('user-input').value = cleanedText;
                return { text: cleanedText, lang };
            } catch (error) {
                addMessage(`Image scan failed: ${error.message}`, false);
                return null;
            }
        }

        // UI Functions
        function addMessage(content, isUser, lang = 'other') {
            const messagesDiv = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            messageDiv.innerHTML = formatContent(content, lang);
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            Prism.highlightAllUnder(messageDiv);
        }

        function formatContent(content, lang) {
            return content.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, language, code) => {
                language = language || lang;
                return `
                    <div class="code-block">
                        <div class="code-header">
                            <span>${language.toUpperCase()}</span>
                            <div>
                                <button onclick="copyCode(this)">Copy</button>
                                ${language === 'js' || language === 'html' ? `<button onclick="runCode(this, '${language}')">Run</button>` : ''}
                            </div>
                        </div>
                        <pre><code class="language-${language}">${code}</code></pre>
                        <div class="output-panel hidden"></div>
                    </div>`;
            });
        }

        function copyCode(button) {
            const code = button.closest('.code-block').querySelector('code').textContent;
            navigator.clipboard.writeText(code);
            button.textContent = 'Copied!';
            setTimeout(() => button.textContent = 'Copy', 2000);
        }

        async function runCode(button, language) {
            const code = button.closest('.code-block').querySelector('code').textContent;
            const outputPanel = button.closest('.code-block').querySelector('.output-panel');
            outputPanel.classList.remove('hidden');
            outputPanel.textContent = 'Running...';

            if (language === 'js') {
                const workerCode = `
                    self.onmessage = function(e) {
                        let output = '';
                        const console = {
                            log: (...args) => output += args.join(' ') + '\\n'
                        };
                        try {
                            eval(e.data);
                            self.postMessage(output || 'No output');
                        } catch (error) {
                            self.postMessage('Error: ' + error.message);
                        }
                    };
                `;
                const blob = new Blob([workerCode], { type: 'application/javascript' });
                const worker = new Worker(URL.createObjectURL(blob));
                worker.postMessage(code);
                worker.onmessage = (e) => {
                    outputPanel.textContent = e.data;
                    worker.terminate();
                };
            } else if (language === 'html') {
                outputPanel.innerHTML = `<iframe class="w-full h-64 bg-white" sandbox="allow-scripts"></iframe>`;
                const iframe = outputPanel.querySelector('iframe');
                iframe.contentDocument.open();
                iframe.contentDocument.write(code);
                iframe.contentDocument.close();
            } else {
                outputPanel.textContent = 'Can’t run this language here!';
            }
        }

        // File Handling
        document.getElementById('file-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (file.type.startsWith('image/')) {
                await processImage(file);
            } else {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const content = event.target.result;
                    const lang = detectLanguage(content);
                    addMessage(`Loaded ${file.name}:\n\`\`\`${lang}\n${content}\n\`\`\``, true, lang);
                    document.getElementById('user-input').value = content;
                };
                reader.readAsText(file);
            }
        });

        // Code Processing
        function processInput() {
            const input = document.getElementById('user-input').value.trim();
            const lang = document.getElementById('language-selector').value;
            if (!input) return;

            addMessage(input, true, lang);
            let response;

            const codeMatch = input.match(/```(\w+)?\n([\s\S]*?)```/);
            if (codeMatch) {
                const codeLang = codeMatch[1] || lang;
                const code = codeMatch[2];
                const text = input.replace(codeMatch[0], '').trim().toLowerCase();

                if (text.includes('debug') || text.includes('fix')) {
                    const { issues, fixes } = ai.debugCode(code, codeLang);
                    response = `Debugging your ${codeLang.toUpperCase()} code:\n`;
                    response += issues.length > 0 ? `Issues found:\n- ${issues.join('\n- ')}` : 'No major bugs—code’s solid!';
                    if (fixes.length > 0) {
                        response += `\n\n**Suggested Fixes:**\n${fixes.join('\n\n')}`;
                    }
                } else if (text.includes('complete') || text.includes('suggest')) {
                    response = ai.processQuery(code, codeLang, true);
                } else if (text.includes('analyze')) {
                    const analysis = ai.analyzeCode(code, codeLang);
                    response = `Analyzing your ${codeLang.toUpperCase()} code:\n`;
                    response += `Errors: ${analysis.errors.join(', ') || 'None'}\n`;
                    response += `Warnings: ${analysis.warnings.join(', ') || 'None'}\n`;
                    response += `Suggestions:\n- ${analysis.suggestions.join('\n- ')}`;
                } else {
                    response = `Got your ${codeLang.toUpperCase()} code! Wanna debug, complete, or analyze it?`;
                }
            } else {
                response = ai.processQuery(input, lang);
            }

            addMessage(response, false, lang);
            document.getElementById('user-input').value = '';
        }

        function analyzeCode() {
            const code = document.getElementById('user-input').value;
            const lang = document.getElementById('language-selector').value;
            if (!code) return addMessage('Yo, paste some code to analyze!', false);

            const analysis = ai.analyzeCode(code, lang);
            let response = `Here’s the lowdown on your ${lang.toUpperCase()} code:\n`;
            response += `Errors: ${analysis.errors.join(', ') || 'None'}\n`;
            response += `Warnings: ${analysis.warnings.join(', ') || 'None'}\n`;
            response += `Suggestions:\n- ${analysis.suggestions.join('\n- ')}`;
            addMessage(response, false);
        }

        function debugCode() {
            const code = document.getElementById('user-input').value;
            const lang = document.getElementById('language-selector').value;
            if (!code) return addMessage('Need code to debug, my dude!', false);

            const { issues, fixes } = ai.debugCode(code, lang);
            let response = `Debugging your ${lang.toUpperCase()} code:\n`;
            response += issues.length > 0 ? `Issues found:\n- ${issues.join('\n- ')}` : 'No bugs found—nice work!';
            if (fixes.length > 0) {
                response += `\n\n**Suggested Fixes:**\n${fixes.join('\n\n')}`;
            }
            addMessage(response, false);
        }

        function completeCode() {
            const code = document.getElementById('user-input').value;
            const lang = document.getElementById('language-selector').value;
            if (!code) return addMessage('Drop some code to complete, yo!', false);

            const response = ai.processQuery(code, lang, true);
            addMessage(response, false);
        }

        function teachMode() {
            const input = document.getElementById('user-input').value.toLowerCase().trim();
            const lang = document.getElementById('language-selector').value;
            if (!input) return addMessage(`What do you wanna learn in ${lang.toUpperCase()}? Try "teach functions".`, false);

            for (const topic in KnowledgeBase.tutorials[lang] || {}) {
                if (input.includes(topic)) {
                    const tutorial = KnowledgeBase.tutorials[lang][topic];
                    addMessage(`Let’s learn ${topic} in ${lang.toUpperCase()}!\n${tutorial.steps.join('\n\n')}\n\n**Your turn:** ${tutorial.exercise}`, false);
                    return;
                }
            }
            addMessage(`I can teach tons in ${lang.toUpperCase()}! Try "teach functions" or "learn classes".`, false);
        }

        function formatCode() {
            const input = document.getElementById('user-input');
            let code = input.value.trim();
            const lang = document.getElementById('language-selector').value;
            if (!code) return addMessage('No code to format!', false);

            if (lang === 'js' || lang === 'ts' || lang === 'java' || lang === 'cpp') {
                code = code.replace(/\n\s*/g, '\n').replace(/\{\s*/g, '{ ').replace(/\}\s*/g, ' }').trim();
            } else if (lang === 'py') {
                code = code.replace(/\n\s*/g, '\n').replace(/^\s+/gm, '    ').trim();
            } else if (lang === 'html' || lang === 'css') {
                code = code.replace(/\n\s*/g, '\n').replace(/>\s*</g, '>\n<').trim();
            } else {
                return addMessage('Formatting not supported for this language.', false);
            }
            input.value = code;
            addMessage(`Formatted your ${lang.toUpperCase()} code—looks clean!`, false);
        }

        function saveSnippet() {
            const code = document.getElementById('user-input').value;
            const lang = document.getElementById('language-selector').value;
            if (!code) return addMessage('No code to save!', false);

            const snippets = JSON.parse(localStorage.getItem('snippets') || '[]');
            snippets.push({ code, lang, name: `Snippet ${snippets.length + 1}` });
            localStorage.setItem('snippets', JSON.stringify(snippets));
            updateSnippetList();
            addMessage('Snippet saved—check the sidebar!', false);
        }

        function updateSnippetList() {
            const snippetList = document.getElementById('snippet-list');
            snippetList.innerHTML = '';
            const snippets = JSON.parse(localStorage.getItem('snippets') || '[]');
            snippets.forEach(snippet => {
                const item = document.createElement('div');
                item.className = 'snippet-item';
                item.textContent = snippet.name;
                item.onclick = () => {
                    addMessage(`\`\`\`${snippet.lang}\n${snippet.code}\n\`\`\``, true, snippet.lang);
                    document.getElementById('user-input').value = snippet.code;
                };
                snippetList.appendChild(item);
            });
        }

        function clearChat() {
            document.getElementById('chat-messages').innerHTML = '';
            addMessage('Chat cleared—let’s code some more!', false);
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function detectLanguage(code) {
            const langSignatures = {
                py: /def\s+\w+\s*\(|import\s+\w+/,
                js: /function\s+\w+\s*\(|const\s+\w+/,
                java: /public\s+class|void\s+main/,
                cpp: /#include|int\s+main/,
                html: /<!DOCTYPE\s+html|<div/,
                css: /{\s*\w+:\s*\w+}/,
                php: /<\?php|\$\w+/,
                ruby: /def\s+\w+|end/,
                go: /func\s+\w+|package\s+main/,
                ts: /:\s*Type|interface\s+\w+/,
                sql: /SELECT\s+|FROM\s+/,
                rust: /fn\s+\w+\(|let\s+\w+:/,
                kotlin: /fun\s+\w+\(|class\s+\w+/,
                swift: /func\s+\w+\(|var\s+\w+:/,
            };
            for (const [lang, pattern] of Object.entries(langSignatures)) {
                if (pattern.test(code)) return lang;
            }
            return 'other';
        }

        // Real-time Suggestions
        let suggestionTimeout;
        document.getElementById('user-input').addEventListener('input', (e) => {
            clearTimeout(suggestionTimeout);
            const input = e.target;
            const value = input.value.trim();
            const lang = document.getElementById('language-selector').value;
            const dropdown = document.getElementById('suggestions-dropdown');

            if (value.length < 3) {
                dropdown.classList.add('hidden');
                return;
            }

            suggestionTimeout = setTimeout(() => {
                const completions = ai.completer.complete(value, lang);
                dropdown.innerHTML = '';
                if (completions.length === 0) {
                    dropdown.classList.add('hidden');
                    return;
                }

                completions.forEach(comp => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.textContent = comp.description;
                    item.onclick = () => {
                        input.value = comp.code;
                        dropdown.classList.add('hidden');
                    };
                    dropdown.appendChild(item);
                });

                dropdown.classList.remove('hidden');
            }, 500);
        });

        document.getElementById('user-input').addEventListener('blur', () => {
            setTimeout(() => document.getElementById('suggestions-dropdown').classList.add('hidden'), 200);
        });

        document.getElementById('user-input').addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                processInput();
                e.preventDefault();
            }
        });

        // Theme Management
        document.getElementById('theme-selector').addEventListener('change', (e) => {
            document.body.className = `${e.target.value}-theme`;
            localStorage.setItem('theme', e.target.value);
            updateMatrixCanvas();
        });

        if (localStorage.getItem('theme')) {
            document.body.className = `${localStorage.getItem('theme')}-theme`;
            document.getElementById('theme-selector').value = localStorage.getItem('theme');
        } else {
            document.body.className = 'matrix-theme';
            document.getElementById('theme-selector').value = 'matrix';
        }

        // Initialization
        addMessage(`Yo, CodeVision AI’s here to code like GitHub Copilot! 🚀\nI can:\n- Suggest completions as you type\n- Debug any language\n- Write code from scratch\n- Teach you step-by-step\n- Analyze and fix code\n- Extract code from images\n- Run JS/HTML in-browser\nPaste some code or ask away!`, false);
        updateSnippetList();
    </script>
</body>
</html>
